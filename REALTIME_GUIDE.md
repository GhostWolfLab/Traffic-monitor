# 实时监听功能使用指南

## ✅ 前置条件

1. **已安装 Scapy**
   ```bash
   pip install scapy
   ```

2. **Windows 用户需要 Npcap**
   - 下载：https://npcap.com/
   - 安装时选择 "WinPcap API-compatible Mode"

3. **管理员权限**
   - Windows: 右键"以管理员身份运行"
   - Linux/Mac: 使用 sudo

## 🚀 使用步骤

### 1. 启动应用

**Windows（管理员）:**
```powershell
python app.py
```

**Linux/Mac:**
```bash
sudo python app.py
```

### 2. 打开浏览器

访问：http://localhost:5000

### 3. 选择网络接口

在"监听接口"下拉框中选择要监听的网卡：
- Windows: 通常是 `\Device\NPF_{GUID}` 格式
- Linux: `eth0`, `wlan0`, `ens33` 等
- Mac: `en0`, `en1` 等

### 4. 选择检测方法

- **Isolation Forest**（推荐）：准确率高，适合实时检测
- **Statistical**：轻量级，基于统计规则

### 5. 设置过滤器（可选）

在"BPF过滤器"输入框中输入过滤规则：

**常用示例：**
```
tcp                          # 只监听TCP流量
port 80                      # 只监听80端口
tcp and port 443             # HTTPS流量
host 192.168.1.1             # 指定主机
net 192.168.0.0/24           # 指定网段
not port 22                  # 排除SSH
```

### 6. 开始监听

点击 **"开始监听"** 按钮

### 7. 查看结果

实时显示：
- **左上**：检测到的威胁模式（动物图标）
- **左下**：数据包流列表
- **右侧**：数据包详细信息

### 8. 停止监听

点击 **"停止监听"** 按钮

## 🔍 实时监听特性

### 自动检测
- 每个数据包实时分析
- 异常即时告警
- 威胁模式自动分类

### 性能优化
- 后台线程处理
- WebSocket 实时推送
- 自动限流（最多1000个包）

### 可视化
- 实时数据包流
- 威胁模式统计
- 颜色区分（绿色=正常，红色=异常）

## ⚠️ 常见问题

### Q: 网络接口列表为空
**A:** 
- 检查是否以管理员/root权限运行
- Windows: 确认 Npcap 已安装
- 重启应用

### Q: 监听无法启动
**A:**
- 确认选择了有效的网络接口（不是"不支持"）
- 检查该接口是否被其他程序占用
- 查看浏览器控制台错误信息

### Q: 没有数据包显示
**A:**
- 检查 BPF 过滤器语法是否正确
- 确认该网卡有流量通过
- 尝试去掉过滤器监听所有流量

### Q: Permission denied 错误
**A:**
- Linux/Mac: 使用 sudo 运行
- Windows: 右键"以管理员身份运行"

### Q: 数据包太多无法查看
**A:**
- 使用 BPF 过滤器缩小范围
- 点击"清空"按钮清除历史
- 系统自动限制最多保留1000个包

## 🎯 实战场景

### 场景1：检测端口扫描
```
过滤器：tcp
监听时长：5-10分钟
预期结果：如有扫描，会显示 🐊 鳄鱼模式
```

### 场景2：监测局域网内部流量
```
过滤器：net 192.168.1.0/24
检测方法：Isolation Forest
预期结果：识别内网异常通信
```

### 场景3：HTTPS流量分析
```
过滤器：tcp and port 443
监听时长：持续
预期结果：检测大流量传输（🦈）或数据外泄（🐘）
```

### 场景4：DNS监控
```
过滤器：udp and port 53
监听时长：持续
预期结果：检测DNS隧道或异常查询
```

## 📊 性能建议

### 轻量级监听
```
接口：单个网卡
过滤器：具体协议（tcp/udp）
检测：Statistical
```

### 深度检测
```
接口：主网卡
过滤器：最小化或无
检测：Isolation Forest
```

### 高流量环境
```
接口：指定网卡
过滤器：严格限定（端口+协议）
检测：Statistical
建议：定期清空数据包列表
```

## 🛡️ 安全提示

1. **仅在授权网络使用**
   - 未经授权监听他人流量可能违法
   - 仅用于自己管理的网络

2. **数据隐私**
   - 工具会显示数据包内容
   - 注意保护敏感信息

3. **资源占用**
   - 高流量可能占用较多CPU/内存
   - 建议使用过滤器减少负载

## 📝 技术细节

### 数据流程
```
网卡 → Scapy → 解析 → 特征提取 → ML检测 → WebSocket → 浏览器
```

### 检测延迟
- 单包分析：< 10ms
- WebSocket推送：< 50ms
- UI更新：< 100ms

### 资源消耗
- CPU：10-30%（取决于流量）
- 内存：50-200MB
- 网络：监听模式，无额外带宽

---

**祝使用愉快！有问题请查看控制台日志或提交 Issue。**
